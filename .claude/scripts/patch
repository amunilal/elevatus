#!/bin/bash

# Claude Code Shortcut: /patch:
# Automatic patch version bump and release
# Usage: /patch: [optional release notes]

set -e

RELEASE_NOTES="$*"
if [ -z "$RELEASE_NOTES" ]; then
    RELEASE_NOTES="Patch release with bug fixes"
fi

echo "🔍 Running TypeScript check..."
npm run type-check

# Get current version
current_version=$(grep '"version"' package.json | sed 's/.*"version": *"\([^"]*\)".*/\1/')
echo "📦 Current version: $current_version"

# Calculate new patch version
IFS='.' read -ra VERSION_PARTS <<< "$current_version"
new_version="${VERSION_PARTS[0]}.${VERSION_PARTS[1]}.$((${VERSION_PARTS[2]} + 1))"

echo "🚀 Bumping to version: $new_version"

# Update package.json
sed -i '' "s/\"version\": \"$current_version\"/\"version\": \"$new_version\"/" package.json

# Update lib/version.ts
sed -i '' "s/version: '$current_version'/version: '$new_version'/" lib/version.ts
sed -i '' "s/releaseDate: '[^']*'/releaseDate: '$(date +%Y-%m-%d)'/" lib/version.ts

echo "📝 Committing version bump..."
git add -A
git commit -m "Release v$new_version

- Updated version to $new_version
- TypeScript checks passed
- $RELEASE_NOTES

🤖 Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>"

echo "🚀 Pushing to remote..."
git push origin main

echo "✅ Released v$new_version successfully!"
echo "🏷️  Version: $new_version"