#!/bin/bash

# Claude Code Shortcut: /hotfix:
# Emergency hotfix with auto-deploy
# Usage: /hotfix: Description of the critical fix

set -e

HOTFIX_DESC="$*"
if [ -z "$HOTFIX_DESC" ]; then
    echo "‚ùå Error: Hotfix description required"
    echo "Usage: /hotfix: Description of the critical fix"
    exit 1
fi

echo "üö® EMERGENCY HOTFIX DEPLOYMENT"
echo "==============================="
echo "Description: $HOTFIX_DESC"
echo ""

echo "üîç Running TypeScript check..."
npm run type-check

# Get current version and bump patch
current_version=$(grep '"version"' package.json | sed 's/.*"version": *"\([^"]*\)".*/\1/')
IFS='.' read -ra VERSION_PARTS <<< "$current_version"
new_version="${VERSION_PARTS[0]}.${VERSION_PARTS[1]}.$((${VERSION_PARTS[2]} + 1))"

echo "üöÄ Creating hotfix version: $new_version"

# Update versions
sed -i '' "s/\"version\": \"$current_version\"/\"version\": \"$new_version\"/" package.json
sed -i '' "s/version: '$current_version'/version: '$new_version'/" lib/version.ts
sed -i '' "s/releaseDate: '[^']*'/releaseDate: '$(date +%Y-%m-%d)'/" lib/version.ts

echo "üìù Committing hotfix..."
git add -A
git commit -m "üö® Hotfix v$new_version

Critical fix: $HOTFIX_DESC

- Updated version to $new_version
- TypeScript checks passed
- Immediate production deployment

ü§ñ Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>"

echo "üöÄ Pushing to repository..."
git push origin main

echo "‚ö° Deploying to production..."
vercel --prod

echo ""
echo "üéâ HOTFIX DEPLOYMENT COMPLETED"
echo "==============================="
echo "üè∑Ô∏è  Version: $new_version"
echo "üåê Production URL: https://elevatus-pm2nhzrfd-ashveer.vercel.app"
echo "‚è∞ Deployed at: $(date)"
echo ""
echo "‚úÖ Critical fix is now live in production!"